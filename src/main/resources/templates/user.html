<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head"></head>
<body>
<div th:replace="fragments/header :: header"></div>

<main class="container">
    <div class="user-card">
        <div class="user-header">
            <div class="user-avatar">üíª</div>
            <div class="user-info">
                <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
                <p class="user-phone" th:text="${phoneNumber} ?: '–ù–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω'"></p>
            </div>
        </div>

        <div th:if="${phoneNumber == null}" class="alert alert-danger">
            –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.
        </div>
    </div>

    <div class="user-card">
        <div class="user-header">
            <h2>–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        </div>
        <!-- –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ -->
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input"
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –¥–∞—Ç–µ, –≤—Ä–µ–º–µ–Ω–∏..."
                   onkeyup="filterBookings()">
            <button class="search-btn" onclick="filterBookings()">
                <i class="bi bi-search"></i> –ü–æ–∏—Å–∫
            </button>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filter-controls">
            <div class="filter-group">
                <span class="filter-label">–°—Ç–∞—Ç—É—Å:</span>
                <select id="statusFilter" class="form-control" onchange="filterBookings()">
                    <option value="ALL">–í—Å–µ</option>
                    <option value="ACTIVE">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="CANCELLED">–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ</option>
                    <option value="COMPLETED">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
                </select>
            </div>

            <div class="filter-group">
                <span class="filter-label">–¢–∏–ø –º–µ—Å—Ç–∞:</span>
                <select id="placeTypeFilter" class="form-control" onchange="filterBookings()">
                    <option value="ALL">–í—Å–µ</option>
                    <option value="–ø–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω–∞—è">–ü–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω–∞—è</option>
                    <option value="—Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ">–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ</option>
                </select>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-hover bookings-table" id="bookingsTable">
                <thead>
                <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–í—Ä–µ–º—è</th>
                    <th>–¢–∏–ø –º–µ—Å—Ç–∞</th>
                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${bookings == null or bookings.isEmpty()}">
                    <td colspan="6" class="text-center py-4 text-muted">
                        –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
                    </td>
                </tr>

                <tr th:each="booking : ${bookings}"
                    class="booking-row"
                    th:data-status="${booking.status.name()}"
                    th:data-place-type="${#strings.toLowerCase(booking.placeType)}">
                    <td th:text="${#temporals.format(booking.date, 'dd.MM.yyyy')}"></td>
                    <td th:text="${#temporals.format(booking.startTime, 'HH:mm')} + '-' + ${#temporals.format(booking.endTime, 'HH:mm')}"></td>
                    <td th:text="${#strings.capitalize(booking.placeType.toLowerCase())}"></td>
                    <td th:text="${booking.price} + ' ‚ÇΩ'"></td>
                    <td>
                        <span th:switch="${booking.status.name()}">
                            <span th:case="'ACTIVE'" class="badge bg-success">–ê–∫—Ç–∏–≤–Ω–æ</span>
                            <span th:case="'CANCELLED'" class="badge bg-secondary">–û—Ç–º–µ–Ω–µ–Ω–æ</span>
                            <span th:case="'COMPLETED'" class="badge bg-secondary">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                        </span>
                    </td>
                    <td>
                        <button th:if="${booking.status.name() == 'ACTIVE'}"
                                class="btn cancel-btn"
                                th:onclick="'cancelBooking(' + ${booking.id} + ')'">
                            –û—Ç–º–µ–Ω–∏—Ç—å
                        </button>
                        <span th:if="${booking.status.name() != 'ACTIVE'}" class="text-muted">‚Äî</span>
                    </td>
                </tr>
                </tbody>
            </table>
            <div id="noResults" class="no-results">
                –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞.
            </div>
        </div>
    </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
    function filterBookings() {
        const searchText = document.getElementById('searchInput').value.toUpperCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const placeTypeFilter = document.getElementById('placeTypeFilter').value.toLowerCase();

        const table = document.getElementById('bookingsTable');
        const rows = table.querySelectorAll('tbody tr.booking-row');
        let visibleCount = 0;

        rows.forEach(row => {
            let matchesSearch = false;
            let matchesStatus = statusFilter === 'ALL' || row.getAttribute('data-status') === statusFilter;
            let matchesPlaceType = placeTypeFilter === 'all' ||
                row.getAttribute('data-place-type').includes(placeTypeFilter);

            // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –≤–æ –≤—Å–µ—Ö –≤–∏–¥–∏–º—ã—Ö —è—á–µ–π–∫–∞—Ö
            if (searchText) {
                const cells = row.querySelectorAll('td');
                cells.forEach(cell => {
                    const text = cell.textContent || cell.innerText;
                    if (text.toUpperCase().includes(searchText)) {
                        matchesSearch = true;
                    }
                });
            } else {
                matchesSearch = true;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –µ—Å–ª–∏ –≤—Å–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
            const shouldShow = matchesSearch && matchesStatus && matchesPlaceType;
            row.style.display = shouldShow ? "" : "none";

            if (shouldShow) visibleCount++;
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
        document.getElementById('noResults').style.display = visibleCount > 0 ? "none" : "block";
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        filterBookings();

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('search')) {
            document.getElementById('searchInput').value = urlParams.get('search');
            filterBookings();
        }
        if (urlParams.has('status')) {
            document.getElementById('statusFilter').value = urlParams.get('status');
            filterBookings();
        }
        if (urlParams.has('placeType')) {
            document.getElementById('placeTypeFilter').value = urlParams.get('placeType');
            filterBookings();
        }
    });
</script>
</body>
</html>